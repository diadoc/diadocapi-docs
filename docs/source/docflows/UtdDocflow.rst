Документооборот УПД
===================

.. note:: Подробнее про УПД можно прочитать на `сайте Диадока <http://www.diadoc.ru/docs/upd>`__.

Форматы
-------

До 1 апреля 2025 года можно использовать следующие форматы универсального передаточного документа (УПД):

	- формат № 820, утвержденный `приказом ФНС России от 19.12.2018 № ММВ-7-15/820@ <https://normativ.kontur.ru/document/last?moduleId=1&documentId=328588&cwi=517>`__,
	- формат № 970, утвержденный `приказом ФНС России от 19.12.2023 № ЕД-7-26/970@ <https://normativ.kontur.ru/document/last?moduleId=1&documentId=464695>`__.

После 1 апреля 2025 года можно будет использовать только формат № 970.

С 1 января 2020 года утратил силу формат №155, утвержденный `приказом ФНС России от 24.03.2016 №ММВ-7-15/155@ <https://normativ.kontur.ru/document/last?moduleId=1&documentId=271958>`__.

Форма универсального передаточного документа, а также рекомендации по его заполнению приведены в `письме ФНС России от 21.10.13 № ММВ-20-3/96@ <https://normativ.kontur.ru/document/last?moduleId=1&documentId=220334>`__.

XSD-схемы первого и второго титулов УПД последней версии форматов можно получить с помощью метода :doc:`../http/GetDocumentTypes`. Метод вернет ссылку для скачивания XSD-схемы в поле ``XsdUrl`` структуры :ref:`DocumentTitleV2`. Инструкция о получении данных из метода ``GetDocumentTypes`` приведена на странице :doc:`../instructions/getdoctypes`.

Подписант
---------

Форматы УПД и УКД подразумевают расширенный набор полей для подписантов. Эти поля не содержатся в сертификате или в данных организации.

Если необходимых для подписания данных нет, то будет возникать ошибка.

Заполнение данных подписанта зависит от формата документа:

	- для формата №820 — с помощью метода :doc:`../http/ExtendedSignerDetailsV2`,
	- для формата №970 — с помощью упрощенного XML-файла подписанта.

Добавить в XML-файл титула информацию о подписанте можно с помощью метода :doc:`../http/PrepareDocumentsToSign`. Подробная информация о типах и данных подписантов описана в разделе :doc:`../instructions/preparetosign`.

Порядок обмена согласно приказу 14Н
-----------------------------------

УПД с функцией СЧФ
~~~~~~~~~~~~~~~~~~

Для документов, возникающих в ходе документооборота УПД с функцией СЧФ, в Диадоке зарезервированы следующие типы вложения ``AttachmentType``:

	- ``UniversalTransferDocument`` — для УПД с функцией СЧФ,
	- ``UniversalTransferDocumentRevision`` — для исправления УПД с функцией СЧФ,
	- ``UniversalCorrectionDocument`` — для корректировки УКД с функцией КСЧФ,
	- ``UniversalCorrectionDocumentRevision`` — для исправления корректировки УКД с функцией КСЧФ.
	- ``InvoiceConfirmation`` — для подтверждения оператора электронного документооборота на УПД (СЧФ)/иУПД (СЧФ)/УКД (КСЧФ)/иУКД (КСЧФ), на извещение о получении УПД (СЧФ)/иУПД (СЧФ)/УКД (КСЧФ)/иУКД (КСЧФ), на уведомление об уточнении УПД (СЧФ)/иУПД (СЧФ)/УКД (КСЧФ)/иУКД (КСЧФ),
	- ``InvoiceCorrectionRequest`` — для уведомления об уточнении УПД (СЧФ)/иУПД (СЧФ)/УКД (КСЧФ)/иУКД (КСЧФ),
	- ``InvoiceReceipt`` — для извещения о получении УПД (СЧФ)/иУПД (СЧФ)/УКД (КСЧФ)/иУКД (КСЧФ).

Порядок обмена
""""""""""""""

Если УПД используется с функцией СЧФ, документооборот повторяет :doc:`документооборот СФ <InvoiceDocflow>`.

#. Продавец формирует УПД (СЧФ) *UniversalTransferDocument*\ :sub:`1`\, подписывает его и направляет Покупателю.

#. Диадок формирует подтверждение оператора *InvoiceConfirmation*\ :sub:`2`\  о дате получения УПД (СЧФ), подписывает его и направляет Продавцу.

#. Диадок формирует подтверждение оператора *InvoiceConfirmation*\ :sub:`2'`\  о дате отправки УПД (СЧФ), подписывает его и направляет вместе с УПД (СЧФ) Покупателю.

#. Покупатель получает УПД (СЧФ) и подтверждение оператора и отправляет в ответ подписанные извещение *InvoiceReceipt*\ :sub:`3`\  о получении УПД (СЧФ).

#. Диадок формирует подтверждение оператора *InvoiceConfirmation*\ :sub:`4`\  о дате получения извещения о получении УПД (СЧФ), подписывает его и направляет Покупателю.

#. Диадок формирует подтверждение оператора *InvoiceConfirmation*\ :sub:`4'`\  о дате отправки извещения о получении УПД (СЧФ), подписывает его и направляет вместе с извещением о получении Продавцу.

#. Если Покупатель обнаружил ошибки в полученном УПД (СЧФ), он формирует уведомление об уточнении УПД (СЧФ) *InvoiceCorrectionRequest*\ :sub:`5`\, подписывает его и направляет Продавцу.

#. Диадок формирует подтверждение оператора *InvoiceConfirmation*\ :sub:`6`\  о дате получения уведомления об уточнении УПД (СЧФ), подписывает его и направляет Покупателю.

#. Диадок формирует подтверждение оператора *InvoiceConfirmation*\ :sub:`6'`\  о дате отправки уведомления об уточнении УПД (СЧФ), подписывает его и направляет вместе с уведомлением об уточнении УПД (СЧФ) Продавцу.

.. image:: ../_static/img/docflows/scheme-14n-utd-invoice-docflow.png
    :align: center


УПД с функцией ДОП
~~~~~~~~~~~~~~~~~~

Для документов, возникающих в ходе документооборота УПД с функцией ДОП, в Диадоке зарезервированы следующие типы вложения ``AttachmentType``:

	- ``UniversalTransferDocument`` — для титула продавца УПД с функцией ДОП,
	- ``UniversalTransferDocumentBuyerTitle`` — для титула покупателя УПД с функцией ДОП.

Порядок обмена
""""""""""""""

Если УПД используется с функцией ДОП, документооборот повторяет документооборот :doc:`актов <AktDocflow>` и :doc:`накладных <Torg12Docflow>`.

#. Продавец формирует титул продавца УПД (ДОП) *UniversalTransferDocument*\ :sub:`1`\, подписывает его и направляет Покупателю.

#. Диадок формирует подтверждение оператора *InvoiceConfirmation*\ :sub:`2`\  о дате получения УПД (ДОП), подписывает его и направляет Продавцу.

#. Диадок формирует подтверждение оператора *InvoiceConfirmation*\ :sub:`2'`\  о дате отправки УПД (ДОП), подписывает его и направляет вместе с УПД (ДОП) Покупателю.

#. Покупатель получает титул продавца УПД (ДОП) *UniversalTransferDocument*\ :sub:`3`\  и при необходимости отправляет в ответ подписанное извещение о получении *Receipt*\ :sub:`4`\.

#. Покупатель формирует титул покупателя *UniversalTransferDocumentBuyerTitle*\ :sub:`5`\, подписывает его и отправляет в сторону Продавца.

#. Диадок формирует подтверждение оператора *InvoiceConfirmation*\ :sub:`6`\  о дате получения УПД (ДОП), подписывает его и направляет Покупателю.

#. Диадок формирует подтверждение оператора *InvoiceConfirmation*\ :sub:`6'`\  о дате отправки УПД (ДОП), подписывает его и направляет вместе с УПД (ДОП) Продавцу.

#. Продавец получает титул покупателя и при необходимости отправляет в ответ подписанное извещение о получении *Receipt*\ :sub:`8`\.

#. Если Покупатель обнаружил ошибки в полученном титуле продавца УПД (ДОП), он формирует отказ в подписи *XmlSignatureRejection*\ :sub:`9`\, подписывает его и направляет Продавцу.

#. Диадок формирует подтверждение оператора *InvoiceConfirmation*\ :sub:`10`\  о дате получения отказа в подписи *XmlSignatureRejection*, подписывает его и направляет Покупателю.

#. Диадок формирует подтверждение оператора *InvoiceConfirmation*\ :sub:`10'`\  о дате отправки отказа в подписи *XmlSignatureRejection*, подписывает его и направляет вместе с отказом в подписи *XmlSignatureRejection*\ :sub:`11`\  Продавцу.

#. Если Покупатель обнаружил ошибки в полученном титуле продавца УПД (ДОП), он формирует уведомление об уточнении УПД (ДОП) *InvoiceCorrectionRequest*\ :sub:`12`\, подписывает его и направляет Продавцу.

#. Диадок формирует подтверждение оператора *InvoiceConfirmation*\ :sub:`13`\  о дате получения уведомления об уточнении УПД (ДОП), подписывает его и направляет Покупателю.

#. Диадок формирует подтверждение оператора *InvoiceConfirmation*\ :sub:`13'`\  о дате отправки уведомления об уточнении УПД (ДОП), подписывает его и направляет вместе с уведомлением об уточнении УПД (ДОП) Продавцу.

.. image:: ../_static/img/docflows/scheme-14n-utd-basic-docflow.png
    :align: center


УПД с функцией СЧФДОП
~~~~~~~~~~~~~~~~~~~~~

Если УПД используется с функцией СЧФДОП, объединяются документообороты для УПД с функцией СЧФ и УПД с фунцией ДОП.

#. Продавец формирует УПД (СЧФДОП) *UniversalTransferDocument*\ :sub:`1`\, подписывает его и направляет Покупателю.

#. Диадок формирует подтверждение оператора *InvoiceConfirmation*\ :sub:`2`\  о дате получения титула продавца УПД (СЧФДОП), подписывает его и направляет Продавцу.

#. Диадок формирует подтверждение оператора *InvoiceConfirmation*\ :sub:`2'`\  о дате отправки титула продавца УПД (СЧФДОП), подписывает его и направляет вместе с УПД (СЧФДОП) Покупателю.

#. Покупатель получает титул продавца УПД (СЧФДОП) и подтверждение оператора и отправляет в ответ подписанное извещение о получении титула продавца УПД (СЧФДОП) *InvoiceReceipt*\ :sub:`3`\.

#. Диадок формирует подтверждение оператора *InvoiceConfirmation*\ :sub:`4`\  о дате получения извещения о получении титула продавца УПД (СЧФДОП), подписывает его и направляет Покупателю.

#. Диадок формирует подтверждение оператора о дате отправки извещения о получении титула продавца УПД (СЧФДОП) *InvoiceConfirmation*\ :sub:`4'`\  , подписывает его и направляет вместе с извещением о получении Продавцу.

#. Покупатель формирует в ответ на титул продавца УПД (СЧФДОП) титул покупателя УПД (СЧФДОП) *UniversalTransferDocumentBuyerTitle*\ :sub:`5`\, подписывает его и отправляет в сторону Продавца.

#. Диадок формирует подтверждение оператора *InvoiceConfirmation*\ :sub:`6`\  о дате получения титула покупателя УПД (СЧФДОП), подписывает его и направляет Покупателю.

#. Диадок формирует подтверждение оператора *InvoiceConfirmation*\ :sub:`6'`\  о дате отправки титула покупателя УПД (СЧФДОП), подписывает его и направляет вместе с титулом покупателя Продавцу.

#. Продавец получает титул покупателя и при необходимости отправляет в ответ подписанное извещение о получении *InvoiceReceipt*\ :sub:`7`\.

#. Если Покупатель обнаружил ошибки в полученном титуле продавца УПД (СЧФДОП), он формирует отказ в подписи *XmlSignatureRejection*\ :sub:`8`\, подписывает его и направляет Продавцу.

#. Диадок формирует подтверждение оператора *InvoiceConfirmation*\ :sub:`9`\  о дате получения отказа в подписи *XmlSignatureRejection*.

#. Диадок формирует подтверждение оператора *InvoiceConfirmation*\ :sub:`9'`\  о дате отправки отказа в подписи, подписывает его и направляет вместе с отказом в подписи *XmlSignatureRejection*  Продавцу..

#. Если Покупатель обнаружил ошибки в полученном титуле продавца УПД (СЧФДОП), он формирует уведомление об уточнении УПД (СЧФДОП) *InvoiceCorrectionRequest*\ :sub:`10`\, подписывает его и направляет Продавцу.

#. Диадок формирует подтверждение оператора *InvoiceConfirmation*\ :sub:`11`\  о дате получения уведомления об уточнении УПД (СЧФДОП), подписывает его и направляет Покупателю.

#. Диадок формирует подтверждение оператора *InvoiceConfirmation*\ :sub:`11'`\  о дате отправки уведомления об уточнении УПД (СЧФДОП), подписывает его и направляет вместе с уведомлением об уточнении УПД (СЧФДОП) Продавцу.

.. image:: ../_static/img/docflows/scheme-14n-utd-docflow.png
    :align: center



Порядок обмена согласно приказу 174Н (утратил силу с 01.07.2021)
----------------------------------------------------------------

.. collapse:: Подробнее

	Порядок документооборота счетов-фактур согласно приказу Минфина `от 10.11.2015 N 174Н <https://normativ.kontur.ru/document/last?moduleId=1&documentId=268278>`_.

	**УПД с функцией СЧФ**

	*Структуры*

	Для документов, возникающих в ходе документооборота УПД с функцией СЧФ, в Диадоке зарезервированы специальные :doc:`типы сущностей <../proto/Entity message>`:

	- для УПД с функцией СЧФ - *Attachment/UniversalTransferDocument*,

	- для исправления УПД с функцией СЧФ - *Attachment/UniversalTransferDocumentRevision*,

	- для корректировки УКД с функцией КСЧФ -  *Attachment/UniversalCorrectionDocument*,

	- для исправления корректировки УКД с функцией КСЧФ - *Attachment/UniversalCorrectionDocumentRevision*.

	Для служебных документов, возникающих в ходе реализации порядка обмена УПД с функцией СЧФ:

	- *Attachment/InvoiceConfirmation* (подтверждение оператора электронного документооборота на УПД (СЧФ)/иУПД (СЧФ)/УКД (КСЧФ)/иУКД (КСЧФ), на извещение о получении УПД (СЧФ)/иУПД (СЧФ)/УКД (КСЧФ)/иУКД (КСЧФ),

	- *Attachment/InvoiceCorrectionRequest* (уведомление об уточнении УПД (СЧФ)/иУПД (СЧФ)/УКД (КСЧФ)/иУКД (КСЧФ)),

	- *Attachment/InvoiceReceipt* (извещение о получении УПД (СЧФ)/иУПД (СЧФ)/УКД (КСЧФ)/иУКД (КСЧФ), подтверждения оператора электронного документооборота, уведомления об уточнении УПД (СЧФ)/иУПД (СЧФ)/УКД (КСЧФ)/иУКД (КСЧФ)).


	*Порядок обмена*

	В случае, когда УПД используется с функцией СЧФ, документооборот повторяет :doc:`документооборот СФ <InvoiceDocflow>`.

	#. Продавец формирует УПД (СЧФ) *UniversalTransferDocument*\ :sub:`1`\, подписывает его и направляет Покупателю.

	#. Диадок формирует подтверждение оператора *InvoiceConfirmation*\ :sub:`2`\  о дате получения УПД (СЧФ), подписывает его и направляет Продавцу.

	#. Диадок формирует подтверждение оператора *InvoiceConfirmation*\ :sub:`2'`\  о дате отправки УПД (СЧФ), подписывает его и направляет вместе с УПД (СЧФ) Покупателю.

	#. Продавец получает подтверждение оператора и отправляет в ответ подписанное извещение *InvoiceReceipt*\ :sub:`3`\  о получении подтверждения.

	#. Покупатель получает УПД (СЧФ) и подтверждение оператора и отправляет в ответ подписанные извещение *InvoiceReceipt*\ :sub:`5`\  о получении УПД (СЧФ) и извещение *InvoiceReceipt*\ :sub:`4`\ о получении подтверждения.

	#. Диадок формирует подтверждение оператора *InvoiceConfirmation*\ :sub:`6`\ о дате отправки извещения о получении УПД (СЧФ), подписывает его и направляет Покупателю.

	#. Покупатель получает подтверждение оператора и отправляет в ответ подписанное извещение *InvoiceReceipt*\ :sub:`7`\  о получении подтверждения.

	#. Если Покупатель обнаружил ошибки в полученном УПД (СЧФ), он формирует уведомление об уточнении УПД (СЧФ) *InvoiceCorrectionRequest*\ :sub:`8`\, подписывает его и направляет Продавцу.

	#. Продавец получает уведомление об уточнении УПД (СЧФ), и отправляет в ответ подписанное извещение *InvoiceReceipt*\ :sub:`9`\ о получении уведомления.

	.. image:: ../_static/img/docflows/scheme-04-utd-invoice-docflow.png
		:align: center


	**УПД с функцией ДОП**

	*Структуры*

	Для документов, возникающих в ходе документооборота УПД с функцией ДОП, в Диадоке зарезервированы специальные :doc:`типы сущностей <../proto/Entity message>`.

	- для титула продавца УПД с функцией ДОП - *Attachment/UniversalTransferDocument*,

	- для титула покупателя УПД с функцией ДОП - *Attachment/UniversalTransferDocumentBuyerTitle*.

	*Порядок обмена*

	В случае, когда УПД используется с функцией ДОП, документооборот повторяет документооборот :doc:`актов <AktDocflow>` и :doc:`накладных <Torg12Docflow>`.

	#. Продавец формирует титул продавца УПД (ДОП) *UniversalTransferDocument*\ :sub:`1`\, подписывает его и направляет Покупателю.

	#. Диадок доставляет титул продавца УПД (ДОП) *UniversalTransferDocument*\ :sub:`1`\  до Покупателя.

	#. Покупатель получает титул продавца УПД (ДОП) *UniversalTransferDocument*\ :sub:`2`\, и формирует в ответ титул покупателя *UniversalTransferDocumentBuyerTitle*\ :sub:`3`\, подписывает его и отправляет в сторону Продавца.

	#. Диадок доставляет титул покупателя УПД (ДОП) *UniversalTransferDocumentBuyerTitle*\ :sub:`4`\  до Продавца.

	#. Если Покупатель обнаружил ошибки в полученном титуле продавца УПД (ДОП), он формирует отказ в подписи *XmlSignatureRejection*\ :sub:`5`\, подписывает его и направляет Продавцу.

	#. Диадок доставляет отказ в подписи *XmlSignatureRejection*\ :sub:`5`\ до Продавца.

	.. image:: ../_static/img/docflows/scheme-05-utd-basic-docflow.png
		:align: center

	**УПД с функцией СЧФДОП**

	В случае, когда УПД используется с функцией СЧФДОП, объединяются документообороты для УПД с фунцией СЧФ и УПД с фунцией ДОП.

	#. Продавец формирует титул продавца УПД (СЧФДОП) *UniversalTransferDocument*\ :sub:`1`\, подписывает его и направляет Покупателю.

	#. Диадок формирует подтверждение оператора *InvoiceConfirmation*\ :sub:`2`\  о дате получения титула продавца УПД (СЧФДОП), подписывает его и направляет Продавцу.

	#. Диадок формирует подтверждение оператора *InvoiceConfirmation*\ :sub:`2'`\  о дате отправки титула продавца УПД (СЧФДОП), подписывает его и направляет вместе со УПД (СЧФДОП) Покупателю.

	#. Продавец получает подтверждение оператора и отправляет в ответ подписанное извещение *InvoiceReceipt*\ :sub:`3`\  о получении подтверждения.

	#. Покупатель получает титул продавца УПД (СЧФДОП) и подтверждение оператора и отправляет в ответ подписанные извещение *InvoiceReceipt*\ :sub:`5`\  о получении титула продавца УПД (СЧФДОП) и извещение *InvoiceReceipt*\ :sub:`4`\  о получении подтверждения.

	#. Диадок формирует подтверждение оператора *InvoiceConfirmation*\ :sub:`6`\  о дате отправки извещения о получении титула продавца УПД (СЧФДОП), подписывает его и направляет Покупателю.

	#. Покупатель получает подтверждение оператора и отправляет в ответ подписанное извещение *InvoiceReceipt*\ :sub:`7`\  о получении подтверждения.

	#. Покупатель формирует в ответ на титул продавца УПД (СЧФДОП), титул покупателя УПД (СЧФДОП) *UniversalTransferDocumentBuyerTitle*\ :sub:`8`\, подписывает его и отправляет в сторону Продавца.

	#. Диадок доставляет титул покупателя УПД (СЧФДОП) *UniversalTransferDocumentBuyerTitle*\ :sub:`9`\  до Продавца.

	#. Если Покупатель обнаружил ошибки в полученном титуле продавца УПД (СЧФДОП), он формирует отказ в подписи *XmlSignatureRejection*\ :sub:`10`\, подписывает его и направляет Продавцу.

	#. Если Покупатель обнаружил ошибки в полученном титуле продавца УПД (СЧФДОП), он формирует уведомление об уточнении УПД (СЧФДОП) *InvoiceCorrectionRequest*\ :sub:`11`\, подписывает его и направляет Продавцу.

	#. Продавец получает уведомление об уточнении УПД (СЧФДОП), и отправляет в ответ подписанное извещение *InvoiceReceipt*\ :sub:`12`\  о получении уведомления.

	.. image:: ../_static/img/docflows/scheme-06-utd-docflow.png
		:align: center