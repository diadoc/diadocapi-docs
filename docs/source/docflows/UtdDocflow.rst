.. _utd-docflow:

Документооборот УПД
===================

Приказом ФНС России от `24.03.2016 №ММВ-7-15/155@ <https://normativ.kontur.ru/document?moduleId=1&documentId=271958>`__, утвержден электронный формат универсального передаточного документа УПД.

.. note::
    Подробнее про УПД можно прочитать `здесь <http://www.diadoc.ru/docs/upd>`__

Новый формат документа можно будет использовать:

- как счет-фактуру;

- как первичный документ, подтверждающий совершение хозяйственной операции;

- как универсальный передаточный документ (УПД), который совмещает в себе счет-фактуру и первичный документ, подтверждающий совершение хозяйственной операции.

.. note::
    Форма универсального передаточного документа, а также рекомендации по его заполнению приведены в письме ФНС России `от 21.10.13 № ММВ-20-3/96@ <https://normativ.kontur.ru/document?moduleId=1&documentId=220334>`__.

Форматы
-------

Электронные УПД в Диадоке можно создавать по формату, утвержденному приказом ФНС `от 24.03.2016 №ММВ-7-15/155@ <https://normativ.kontur.ru/document?moduleId=1&documentId=271958>`__.

В силу приказа `№ММВ-7-15/155@ <https://normativ.kontur.ru/document?moduleId=1&documentId=271958>`__ электронный УПД может быть в следующем формате:

-  :download:`XSD-схема 1-го титула формата УПД <../xsd/ON_SCHFDOPPR_1_995_01_05_01_04.xsd>`;

    -  используется при передаче УПД с функцией СЧФ, ДОП, СЧФДОП;

-  :download:`XSD-схема 2-го титула формата УПД <../xsd/ON_SCHFDOPPOK_1_995_02_05_01_04.xsd>`;

    -  используется при передаче УПД с функцией ДОП, СЧФДОП;


УПД с функцией СЧФ
------------------

Структуры
~~~~~~~~~

Для документов, возникающих в ходе документооборота УПД с функцией СЧФ, в Диадоке зарезервированы специальные :doc:`типы сущностей <../proto/Entity message>`.

Для УПД с функцией СЧФ можно использовать следующую структуру:

-  *Attachment/UniversalTransferDocument* (*FunctionType.Invoice*),

Для исправления УПД с функцией СЧФ можно использовать следующую структуру:

-  *Attachment/UniversalTransferDocumentRevision* (*FunctionType.Invoice*),

Для корректировки УКД с функцией КСЧФ можно использовать следующую структуру:

-  *Attachment/UniversalCorrectionDocument* (*FunctionType.Invoice*),

Для исправления корректировки УКД с функцией КСЧФ можно использовать следующую структуру:

-  *Attachment/UniversalCorrectionDocumentRevision* (*FunctionType.Invoice*),

Для служебных документов, возникающих в ходе реализации порядка обмена ЭСФ, можно использовать следующую структуру:

-  *Attachment/InvoiceConfirmation* (подтверждение оператора электронного документооборота, для обоих приказов),

-  *Attachment/InvoiceCorrectionRequest* (уведомление об уточнении СФ/ИСФ/КСФ/ИКСФ, для обоих приказов),

-  *Attachment/InvoiceReceipt* (извещение о получении СФ/ИСФ/КСФ/ИКСФ, подтверждения оператора электронного документооборота или уведомления об уточнении СФ/ИСФ/КСФ/ИКСФ, для обоих приказов).


Порядок обмена
~~~~~~~~~~~~~~

В случае, когда УПД используется с функцией СЧФ (*FunctionType.Invoice*), документооборот повторяет :doc:`документооборот СФ <InvoiceDocflow>`.

#.  Продавец формирует УПД (СЧФ) *UniversalTransferDocument*\ :sub:`1`\, подписывает его и направляет Покупателю.

#.  Диадок формирует подтверждение оператора *InvoiceConfirmation*\ :sub:`2`\ о дате получения УПД (СЧФ), подписывает его и направляет Продавцу.

#.  Диадок формирует подтверждение оператора *InvoiceConfirmation*\ :sub:`2'`\ о дате отправки УПД (СЧФ), подписывает его и направляет вместе со счетом фактурой Покупателю.

#.  Продавец получает подтверждение оператора и отправляет в ответ подписанное извещение *InvoiceReceipt*\ :sub:`3`\ о получении подтверждения.

#.  Покупатель получает УПД (СЧФ) и подтверждение оператора и отправляет в ответ подписанные извещение *InvoiceReceipt*\ :sub:`5`\ о получении УПД (СЧФ) и извещение *InvoiceReceipt*\ :sub:`4`\ о получении подтверждения.

#.  Диадок формирует подтверждение оператора *InvoiceConfirmation*\ :sub:`6`\ о дате отправки извещения о получении УПД (СЧФ), подписывает его и направляет Покупателю.

#.  Покупатель получает подтверждение оператора и отправляет в ответ подписанное извещение *InvoiceReceipt*\ :sub:`7`\ о получении подтверждения.

#.  Если Покупатель обнаружил ошибки в полученном УПД (СЧФ), он формирует уведомление об уточнении УПД (СЧФ) *InvoiceCorrectionRequest*\ :sub:`8`\, подписывает его и направляет Продавцу.

#.  Продавец получает уведомление об уточнении УПД (СЧФ), и отправляет в ответ подписанное извещение *InvoiceReceipt*\ :sub:`9`\ о получении уведомления.

.. image:: ../_static/img/docflows/scheme-04-utd-invoice-docflow.png
    :align: center

Таким образом:

-  со стороны получателя необходимо отправить *InvoiceReceipt* на *InvoiceConfirmation* от оператора, а также отправить *InvoiceReceipt* на документ УПД с функцией СЧФ.

-  со стороны отправителя необходимо сформировать *InvoiceReceipt* на *InvoiceConfirmation* от оператора и получить *InvoiceReceipt* по документу УПД.


УПД с функцией ДОП
------------------

Структуры
~~~~~~~~~

Для документов, возникающих в ходе документооборота УПД с функцией ДОП, в Диадоке зарезервированы специальные :doc:`типы сущностей <../proto/Entity message>`.

Для титула продавца УПД с функцией ДОП можно использовать следующую структуру:

-  *Attachment/UniversalTransferDocument* (*FunctionType.Basic*),

Для титула покупателя УПД с функцией ДОП можно использовать следующую структуру:

-  *Attachment/UniversalTransferDocumentBuyerTitle* (*FunctionType.Basic*),

Порядок обмена
~~~~~~~~~~~~~~

В случае, когда УПД используется с функцией ДОП (*FunctionType.Basic*), документооборот повторяет документооборот :doc:`актов <AktDocflow>` и :doc:`накладных <Torg12Docflow>`.

#.  Продавец формирует титул продавца УПД (ДОП) *UniversalTransferDocument*\ :sub:`1`\, подписывает его и направляет Покупателю.

#.  Диадок доставляет титул продавца УПД (ДОП) *UniversalTransferDocument*\ :sub:`1`\ до Покупателя.

#.  Покупатель получает титул продавца УПД (ДОП) *UniversalTransferDocument*\ :sub:`2`\, и формирует в ответ титул покупателя *UniversalTransferDocumentBuyerTitle*\ :sub:`3`\, подписывает его и отправляет в сторону Продавца.

#.  Диадок доставляет титул покупателя УПД (ДОП) *UniversalTransferDocumentBuyerTitle*\ :sub:`4`\ до Продавца.

#.  Если Покупатель обнаружил ошибки в полученном титуле продавца УПД (ДОП), он формирует отказ в подписи *XmlSignatureRejection*\ :sub:`5`\, подписывает его и направляет Продавцу.

#.  Диадок доставляет отказ в подписи *XmlSignatureRejection*\ :sub:`5`\ до Продавца.

.. image:: ../_static/img/docflows/scheme-05-utd-basic-docflow.png
    :align: center

Таким образом:

-  со стороны получателя необходимо сгенерировать и отправить ответный титул покупателя, либо отказ в подписи.

-  со стороны отправителя необходимо сгенерировать и отправить первичный титул продавца.

УПД с функцией СЧФДОП
---------------------

В случае, когда УПД используется с функцией СЧФДОП (*FunctionType.InvoiceAndBasic*), объединяются документообороты для *FunctionType.Invoice* и *FunctionType.Basic*.

#.  Продавец формирует титул продавца УПД (СЧФДОП) *UniversalTransferDocument*\ :sub:`1`\, подписывает его и направляет Покупателю.

#.  Диадок формирует подтверждение оператора *InvoiceConfirmation*\ :sub:`2`\ о дате получения титула продавца УПД (СЧФДОП), подписывает его и направляет Продавцу.

#.  Диадок формирует подтверждение оператора *InvoiceConfirmation*\ :sub:`2'`\ о дате отправки титула продавца УПД (СЧФДОП), подписывает его и направляет вместе со УПД (СЧФДОП) Покупателю.

#.  Продавец получает подтверждение оператора и отправляет в ответ подписанное извещение *InvoiceReceipt*\ :sub:`3`\ о получении подтверждения.

#.  Покупатель получает титул продавца УПД (СЧФДОП) и подтверждение оператора и отправляет в ответ подписанные извещение *InvoiceReceipt*\ :sub:`5`\ о получении титула продавца УПД (СЧФДОП) и извещение *InvoiceReceipt*\ :sub:`4`\ о получении подтверждения.

#.  Диадок формирует подтверждение оператора *InvoiceConfirmation*\ :sub:`6`\ о дате отправки извещения о получении титула продавца УПД (СЧФДОП), подписывает его и направляет Покупателю.

#.  Покупатель получает подтверждение оператора и отправляет в ответ подписанное извещение *InvoiceReceipt*\ :sub:`7`\ о получении подтверждения.

#.  Покупатель формирует в ответ на титул продавца УПД (СЧФДОП), титул покупателя УПД (СЧФДОП) *UniversalTransferDocumentBuyerTitle*\ :sub:`8`\, подписывает его и отправляет в сторону Продавца.

#.  Диадок доставляет титул покупателя УПД (СЧФДОП) *UniversalTransferDocumentBuyerTitle*\ :sub:`9`\ до Продавца.

#.  Если Покупатель обнаружил ошибки в полученном титуле продавца УПД (СЧФДОП), он формирует отказ в подписи *XmlSignatureRejection*\ :sub:`10`\, подписывает его и направляет Продавцу.

#.  Если Покупатель обнаружил ошибки в полученном титуле продавца УПД (СЧФДОП), он формирует уведомление об уточнении УПД (СЧФДОП) *InvoiceCorrectionRequest*\ :sub:`11`\, подписывает его и направляет Продавцу.

#.  Порядок отправки структур *InvoiceReceipt*\ :sub:`4`\ и *UniversalTransferDocumentBuyerTitle*\ :sub:`9`\ покупателем не важен.

#.  Продавец получает уведомление об уточнении УПД (СЧФДОП), и отправляет в ответ подписанное извещение *InvoiceReceipt*\ :sub:`12`\ о получении уведомления.

.. image:: ../_static/img/docflows/scheme-06-utd-docflow.png
    :align: center

Таким образом:

-  со стороны покупателя нужно сформировать и отправить *InvoiceReceipt* на *InvoiceConfirmation*, *InvoiceReceipt* на документ УПД (СЧФДОП), а также титул покупателя УПД (СЧФДОП).

-  со стороны отправителя необходимо сформировать *InvoiceReceipt* на *InvoiceConfirmation* от оператора, получить *InvoiceReceipt* по документу, получить титул покупателя УПД (СЧФДОП).

Подписанты
----------

Набор необходимых полей для подписания счетов-фактур, актов и накладных был значительно меньше, чем для подписания УПД и УКД.

Все данные подписанта доставались из сертификата и данных его организации - автоматическое заполнение данных подписанта происходило при заполнении *BoxId* и *Certificate/CertificateThumbprint*.

Форматы УПД и УКД подразумевают расширенный набор полей для подписантов. Этот набор полей не содержится ни в сертификате, ни в данных организации.

Но логика автоматического заполнения данных о подписантах сохранилась и при подписании УПД и УКД.

Автоматическое заполнение происходит, если в Диадоке есть дополнительные данные, необходимые для подписания. Если дополнительных данных, необходимых для подписания в Диадоке нет, то будет возникать ошибка.

Расширенные данные можно заполнить методом :doc:`../http/utd/ExtendedSignerDetailsV2`.

Для указания этих данных в Диадоке добавлены следующие структуры и методы:

-  структура для описания реквизитов продавца, покупателя и грузоотправителя, используемая в УПД и УКД - :doc:`../proto/utd/ExtendedOrganizationInfo`

-  структура для описания реквизитов подписанта, используемая в УПД и УКД - :doc:`../proto/utd/ExtendedSigner`

-  структура для описания реквизитов подписанта, используемая в методе :doc:`../http/utd/ExtendedSignerDetailsV2` - :doc:`../proto/utd/ExtendedSignerDetailsToPost`
