Работа с документами с маркированными товарами
==============================================

ЭДО и система маркировки
------------------------

С 1 июля 2020 года маркировка табака, обуви и лекарств стала обязательной. Все участники оборота этих товаров должны передавать сведения о переходе права собственности на товар оператору маркировки ГИС МТ “Честный ЗНАК”. 

В общем процесс маркировки выглядит следующим образом:

-  Производитель или импортер при отгрузке товара формирует  электронный УПД с кодами маркировки, подписывает и отправляет его. 
-  Магазин принимает товар и подписывает полученный УПД. После этого документ передается в ГИС МТ “Честный ЗНАК” для проверки и изменения прав собственности. Товары складируются и ждут решения от оператора маркировки.
-  В случае успешной обработки документа в ГИС МТ “Честный ЗНАК” Магазин становится владельцем кодов и может реализовывать маркированный товар дальше — выставлять в торговый зал и продавать конечному покупателю.

Рассмотрим процесс работы с маркированными товарами через api Диадока, который включает следующие шаги:

*Продавец*:

-  генерирует титул продавца с маркированными товарами,
-  отправляет его покупателю.

*Покупатель*:

-  получает титул продавца с маркированными товарами,
-  генерирует титул покупателя,
-  отправляет его продавцу.

*Оператор ЭДО*:

-  отправляет документ с маркированными товарами в ГИС МТ "Честный ЗНАК",
-  получает промежуточные и конечный статусы обработки документа в ГИС МТ "Честный ЗНАК".

*Участник ЭДО (продавец или покупатель)*:

-  узнает через api статус обработки документа в ГИС МТ "Честный ЗНАК".

Генерация, подписание, отправка документов с маркированными товарами
--------------------------------------------------------------------
Выполняются аналогично документам без маркированных товаров. Подробнее об этом можно почитать в `статье про работу с документами 820 формата <https://api-docs.diadoc.ru/ru/latest/howto/utd820.html>`.

Передача документов в ГИС МТ "Честный ЗНАК"
-------------------------------------------

.. csv-table:: Типы документов, по которым нужно передавать данныев ГИС МТ "Честный ЗНАК"
   :header: "TypeNamedId", "Function", "Version", "Формат", "Дополнительные условия"
   :widths: 10, 10, 10, 10, 10
   
   "UniversalTransferDocument", "СЧФДОП, ДОП", "utd820_05_01_01, utd820_05_01_01_hyphen", "приказ №820", "В документах должны быть данные по маркированным товарам:
   - префикс в ИдФайл равен ON_NSCHFDOPPRMARK в 1 титуле и ON_NSCHFDOPOKMARK во 2 титуле,
   - внутри элемента Документ/ТаблСчФакт/СведТов/ДопСведТов/НомСредИдентТов указаны коды маркировки"
   "UniversalTransferDocumentRevision", "СЧФДОП, ДОП", "utd820_05_01_01, utd820_05_01_01_hyphen", "приказ №820", "В документах должны быть данные по маркированным товарам:
   - префикс в ИдФайл равен ON_NSCHFDOPPRMARK в 1 титуле и ON_NSCHFDOPOKMARK во 2 титуле,
   - внутри элемента Документ/ТаблСчФакт/СведТов/ДопСведТов/НомСредИдентТов указаны коды маркировки"
   "UniversalTransferDocument", "СЧФДОП, ДОП", "utd_05_01_05, utd_05_02_01", "приках №155 (формат действовал до 31.12.2019)", "В документах должны быть данные по маркированным товарам:
   - в Документ/ТаблСчФакт/СведТов/ИнфПолФХЖ2 указаны коды маркировки в формате <ИнфПолФХЖ2 Идентиф=cis Значен=...>"
   "UniversalTransferDocumentRevision", "СЧФДОП, ДОП", "utd_05_01_05, utd_05_02_01", "приках №155 (формат действовал до 31.12.2019)", "В документах должны быть данные по маркированным товарам:
   - в Документ/ТаблСчФакт/СведТов/ИнфПолФХЖ2 указаны коды маркировки в формате <ИнфПолФХЖ2 Идентиф=cis Значен=...>"
   "XmlTorg12", "default", " utd820_05_01_01, utd820_05_01_01_hyphen", "приказ №820", "В документах должны быть данные по маркированным товарам:
   - префикс в ИдФайл равен ON_NSCHFDOPPRMARK в 1 титуле и ON_NSCHFDOPOKMARK во 2 титуле,
   - внутри элемента Документ/ТаблСчФакт/СведТов/ДопСведТов/НомСредИдентТов указаны коды маркировки"
   "UniversalCorrectionDocument", "КСЧФДИС, ДИС", "ucd_05_01_05, ucd_05_02_01", "приках №189", "В документах должны быть данные по маркированным товарам:
   - в Документ/ТаблСчФакт/СведТов/ИнфПолФХЖ2 указаны коды маркировки в формате <ИнфПолФХЖ2 Идентиф=cis Значен=...>"
   "UniversalCorrectionDocumentRevision", "КСЧФДИС, ДИС", "ucd_05_01_05, ucd_05_02_01", "приках №189", "В документах должны быть данные по маркированным товарам:
   - в Документ/ТаблСчФакт/СведТов/ИнфПолФХЖ2 указаны коды маркировки в формате <ИнфПолФХЖ2 Идентиф=cis Значен=...>"
   
Данные в ГИС МТ "Честный ЗНАК" нужно передавать:
-  после подписания документа обеими сторонами,
-  после аннулирования подписанного документа.

Чтобы данные по документам передавались в ГИС МТ автоматически, нужно подключить `сервис <https://www.diadoc.ru/lp-edovmarkirovke>` передачи данных.

Получение статуса ГИС МТ "Честный ЗНАК"
---------------------------------------

.. csv-table:: Список статусов ГИС МТ "Честный ЗНАК"
   :header: "Статус", "Когда возникает", "Какие данные возвращаются"
   :widths: 10, 10, 10
   
   "Обрабатывается в ГИС МТ Честный ЗНАК", "Статус возвращается после успешной передачи документа в ГИС МТ Честный ЗНАК", "- статус, 
   - транспортная квитанция ГИС МТ"
   "Обработан в ГИС МТ Честный ЗНАК", "Статус возвращается после успешной обработки документа в ГИС МТ Честный ЗНАК. Данный статус означает, что произошел переход прав собственности на маркированные товары", "- статус,
   - технологическая квитанция ГИС МТ"
   "Ошибка в ГИС МТ Честный ЗНАК", "Статус возвращается, если в процессе обработки документа в ГИС МТ Честный ЗНАК возникли ошибки.", "- статус,
   - технологическая квитанция ГИС МТ,
   - список ошибок, которые возникли в ходе обработки документа"
   "Передается в ГИС МТ Честный ЗНАК", "Статус возвращается, если ГИС МТ Честный ЗНАК недоступен, документ передать не удалось, но попытки передачи продолжаются", "- статус,
   - файл с текстом ошибки"
   "Ошибка передачи в ГИС МТ Честный ЗНАК", "Статус возвращается, если при передаче документа в ГИС МТ Честный ЗНАК получена ошибка 4хх или 500, документ передать не удалось, повторные попытки передачи не выполняются", "- статус,
   - транспортная квитанция ГИС МТ"

Информацию о статусе обработки документов в ГИС МТ “Честный ЗНАК” можно получить в виде структуры :doc:`../proto/OuterDocflow` в методах:

-  работы с сообщениями :doc:`../http/GetMessage` - возвращается информация о всех полученных статусах ГИС МТ
-  работы с событиями :doc:`../http/GetEvent`, :doc:`../http/GetNewEvents`, :doc:`../http/GetLastEvent` - - возвращается информация о всех полученных статусах ГИС МТ,  
-  работы с документами :doc:`../http/GetDocument`, :doc:`../http/GetDocumentsByMessageId`, :doc:`../http/GetDocuments` - возвращается только последний полученный статус по документу либо запросу на аннулирование.

В :doc:`../proto/OuterDocflow` может содержаться информация не только о взаимодействии с ГИС МТ "Честный ЗНАК", но и о других внешних документооборотах. Статусам ГИС МТ "Честный ЗНАК" соответствует DocflowNamedId=TtGis

Пример ответа:

.. sourcecode:: json

   "OuterDocflowInfo":
   {
      "DocflowNamedId": "TtGis",
      "DocflowFriendlyName":"ГИС МТ",
      "Status":{
        "NamedId":"ProcessingError",
        "FriendlyName":"Ошибка в ГИС МТ ""Честный ЗНАК""",
        "Type":"Error",   
        "Details":[
        {
        "Code":"4",
        "Text":"Документ с таким номером уже зарегистрирован в ГИС МТ"
        },
        {
        "Code":"24",
        "Text":"Статус кода маркировки {КМ} не соответствует выполняемой операции"
        }
     ]}
   }

В DocflowAPI V3 данные о статусах ГИС МТ можно получить в :doc:`../http/GetDocflows_V3`, :doc:`../http/GetDocflowsByPacketId_V3`, :doc:`../http/SearchDocflows_V3`, :doc:`../http/GetDocflowEvents_V3` в виде структур:

-  :doc:`../proto/OuterDocflow` - информация о последнем полученном статусе ГИС МТ. 
-  :doc:`../proto/OuterDocflowEntities` - информация о всех полученных статусах ГИС МТ. 

В :doc:`../proto/OuterDocflow` и :doc:`../proto/OuterDocflowEntities` может содержаться информация не только о взаимодействии с ГИС МТ "Честный ЗНАК", но и о других внешних документооборотах. Статусам ГИС МТ "Честный ЗНАК" соответствует DocflowNamedId=TtGis

Пример ответа:

.. sourcecode:: json
