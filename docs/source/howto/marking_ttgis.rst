Работа с документами с маркированными товарами
==============================================

.. contents:: :local:
	:depth: 3

ЭДО и система маркировки
------------------------

С 1 января 2019 года действует `Федеральный закон от 25.12.2018 N 488-ФЗ <https://normativ.kontur.ru/document/last?moduleId=1&documentId=327036&cwi=09>`__, который определяет требования к работе с маркированными товарами. Все участники оборота маркированных товаров должны передавать сведения о переходе права собственности на товар в информационную систему оператора маркировки ГИС МТ «Честный ЗНАК». С 1 января 2022 года передавать сведения о движении продукции — вводе в оборот, продаже, выводе из оборота — можно только через оператора ЭДО. Это требование закреплено в постановлениях Правительства `N 2464 от 31.12.2020 <https://normativ.kontur.ru/document/last?moduleId=1&documentId=380743&cwi=166>`__ и `N 64 от 28.01.2021 <https://normativ.kontur.ru/document/last?moduleId=1&documentId=382401&cwi=104>`__.

Рассмотрим сценарий работы с маркированными товарами в Диадоке для каждого участника документооборота:

Продавец:
	- генерирует титул продавца с маркированными товарами,
	- отправляет его покупателю.

Покупатель:
	- получает титул продавца с маркированными товарами,
	- генерирует титул покупателя,
	- отправляет его продавцу.

Оператор ЭДО:
	- отправляет документ с маркированными товарами в ГИС МТ «Честный ЗНАК»,
	- получает промежуточные и конечный статусы обработки документа в ГИС МТ «Честный ЗНАК».

Продавец и покупатель:
	- узнают статус обработки документа в ГИС МТ «Честный ЗНАК»,
	- если необходимо, получают контент квитанции ГИС МТ «Честный ЗНАК» с помощью метода :doc:`../http/GetEntityContent`.

Генерация, подписание, отправка документов с маркированными товарами выполняются аналогично документам без маркированных товаров. Подробнее об этом читайте в `статье о работе с документами 820 формата <https://api-docs.diadoc.ru/ru/latest/howto/utd820.html>`_.


Передача документов в ГИС МТ «Честный ЗНАК»
-------------------------------------------

Для передачи информации о документах в ГИС МТ должен быть подключен `сервис передачи данных <https://www.diadoc.ru/lp-edovmarkirovke>`_.

Диадок передает сведения в ГИС МТ «Честный ЗНАК»:

- после подписания документа обеими сторонами,
- после аннулирования подписанного документа.

.. table:: Типы документов, по которым в ГИС МТ «Честный ЗНАК» передаются сведения

	+-------------------------------------+--------------+-------------------------+-------------+-----------------------------------------------------------------------------------------------------------------------------------------+
	| TypeNamedId                         | Function     | Version                 | Формат      | Дополнительные условия                                                                                                                  |
	+=====================================+==============+=========================+=============+=========================================================================================================================================+
	| UniversalTransferDocument           | СЧФДОП, ДОП  | utd820_05_01_01         | приказ №820 |                                                                                                                                         |
	|                                     |              | utd820_05_01_01_hyphen, |             |                                                                                                                                         |
	|                                     |              | utd820_05_01_02_hyphen  |             |                                                                                                                                         |
	+-------------------------------------+--------------+-------------------------+-------------+                                                                                                                                         |
	| UniversalTransferDocumentRevision   | СЧФДОП, ДОП  | utd820_05_01_01,        | приказ №820 | В документах должны быть данные по маркированным товарам:                                                                               |
	|                                     |              | utd820_05_01_01_hyphen, |             |                                                                                                                                         |
	|                                     |              | utd820_05_01_02_hyphen  |             |  - префикс в ИдФайл равен ON_NSCHFDOPPRMARK в 1 титуле и ON_NSCHFDOPOKMARK во 2 титуле                                                  |
	+-------------------------------------+--------------+-------------------------+-------------+  - внутри элемента Документ/ТаблСчФакт/СведТов/ДопСведТов/НомСредИдентТов указаны коды маркировки                                       |
	| XmlTorg12                           | default      | utd820_05_01_01,        | приказ №820 |                                                                                                                                         |
	|                                     |              | utd820_05_01_01_hyphen, |             |                                                                                                                                         |
	|                                     |              | utd820_05_01_02_hyphen  |             |                                                                                                                                         |
	+-------------------------------------+--------------+-------------------------+-------------+-----------------------------------------------------------------------------------------------------------------------------------------+
	| UniversalCorrectionDocument         | КСЧФДИС, ДИС | ucd736_05_01_02,        | приказ №736 |                                                                                                                                         |
	|                                     |              | ucd736_05_01_01         |             | В документах должны быть данные по маркированным товарам:                                                                               |
	|                                     |              |                         |             |                                                                                                                                         |
	+-------------------------------------+--------------+-------------------------+-------------+  - префикс в ИдФайл равен ON_NKORSCHFDOPPRMARK в 1 титуле и ON_NKORSCHFDOPPRMARK во 2 титуле                                            |
	| UniversalCorrectionDocumentRevision | КСЧФДИС, ДИС | ucd736_05_01_02,        | приказ №736 |  - внутри элементов Документ.ТаблКСчФ.СведТов.НомСредИдентТовДо и Документ.ТаблКСчФ.СведТов.НомСредИдентТовПосле указаны коды маркировки|
	|                                     |              | ucd736_05_01_01         |             |                                                                                                                                         |
	|                                     |              |                         |             |                                                                                                                                         |
	+-------------------------------------+--------------+-------------------------+-------------+-----------------------------------------------------------------------------------------------------------------------------------------+

Получение статуса ГИС МТ «Честный ЗНАК»
---------------------------------------

Информацию о статусе обработки документов в ГИС МТ «Честный ЗНАК» можно получить в виде структуры :doc:`../proto/OuterDocflow` в методах:

- Работы с сообщениями :doc:`../http/GetMessage`. Метод возвращает информацию обо всех полученных статусах ГИС МТ.
- Работы с событиями :doc:`../http/GetEvent`, :doc:`../http/GetNewEvents`, :doc:`../http/GetLastEvent`. Методы возвращают информацию обо всех полученных статусах ГИС МТ.
- Работы с документами :doc:`../http/GetDocument`, :doc:`../http/GetDocumentsByMessageId`, :doc:`../http/GetDocuments`. Методы возвращают только последний полученный статус по документу или запросу на аннулирование.

Структура :doc:`../proto/OuterDocflow` может содержать информацию о других внешних документооборотах. Статусам ГИС МТ «Честный ЗНАК» соответствует идентификатор ``DocflowNamedId = TtGis``.

Пример структуры, которая вернется в ответе:

.. code-block:: json

   "OuterDocflowInfo":
   {
      "DocflowNamedId": "TtGis",
      "DocflowFriendlyName":"ГИС МТ",
      "Status":{
        "NamedId":"ProcessingError",
        "FriendlyName":"Ошибка в ГИС МТ ""Честный ЗНАК""",
        "Type":"Error",   
        "Details":[
        {
           "Code":"4",
           "Text":"Документ с таким номером уже зарегистрирован в ГИС МТ"
        },
        {
           "Code":"24",
           "Text":"Статус кода маркировки {КМ} не соответствует выполняемой операции"
        }
     ]}
   }

В :doc:`DocflowAPI V3 <../Docflow API>` статусы ГИС МТ можно получить с помощью методов :doc:`../http/GetDocflows_V3`, :doc:`../http/GetDocflowsByPacketId_V3`, :doc:`../http/SearchDocflows_V3` и :doc:`../http/GetDocflowEvents_V3` в виде структур:

- :doc:`../proto/OuterDocflow`. Структура содержит информацию о последнем полученном статусе ГИС МТ. 
- :doc:`../proto/OuterDocflowEntities`. Структура содержит информацию обо всех полученных статусах ГИС МТ. 

Структуры :doc:`../proto/OuterDocflow` и :doc:`../proto/OuterDocflowEntities` могут содержать информацию о других внешних документооборотах. Статусам ГИС МТ «Честный ЗНАК» соответствует идентификатор ``DocflowNamedId = TtGis``.

Структура :doc:`../proto/OuterDocflowEntities` будет содержаться внутри других структур в зависимости от сущности:

- для документа в структуре :doc:`../proto/DocflowV3`,
- для запроса на аннулирование в структуре :doc:`../proto/RevocationDocflowV3`.

Пример структуры, которая вернется в ответе:

.. code-block:: json

   "OuterDocflows": [
      {
         "DocflowNamedId": "TtGis",
         "ParentEntityId": "d2cdd36a-a1bc-47a4-a358-3e344dca7bc2",
         "OuterDocflowEntityId": "c75815a2-6dfc-43bb-997a-1dbaba4b08a3"
      }
   ],
   "OuterDocflowEntities": [
      {
         "DocflowNamedId": "TtGis",
         "DocflowFriendlyName": "ГИС МТ",
         "StatusEntities": [
            {
               "Attachment": {
                  "Attachment": {
                     "Entity": {
                        "EntityId": "14aed39d-70e3-49e4-a3e4-c1cde04fd506",
                        "CreationTimestamp": {
                           "Ticks": 637359498817771378
                        },
                        "Content": {
                           "Size": 829
                        }
                     },
                     "AttachmentFilename": "TtGis_InProcessing_20200904_145417.xml",
                     "DisplayFilename": ""
                  }
               },
               "Status": {
                  "NamedId": "InProcessing",
                  "FriendlyName": "Обрабатывается в ГИС МТ \"Честный ЗНАК\"",
                  "Type": "Normal",
                  "Description": "Документ обрабатывается в ГИС МТ \"Честный ЗНАК\".",
                  "Details": []
               }
            },
            {
               "Attachment": {
                  "Attachment": {
                     "Entity": {
                        "EntityId": "c75815a2-6dfc-43bb-997a-1dbaba4b08a3",
                        "CreationTimestamp": {
                           "Ticks": 637359499045398064
                        },
                        "Content": {
                           "Size": 1092
                        }
                     },
                     "AttachmentFilename": "TtGis_SuccessProcessed_20200904_145520.json",
                     "DisplayFilename": ""
                  }
               },
               "Status": {
                  "NamedId": "SuccessProcessed",
                  "FriendlyName": "Обработан в ГИС МТ \"Честный ЗНАК\"",
                  "Type": "Success",
                  "Description": "Документ обработан в ГИС МТ \"Честный ЗНАК\".",
                  "Details": []
               }
            }
         ]
      }
   ]

Статусы ГИС МТ «Честный ЗНАК»
-----------------------------

.. table:: Описание статусов ГИС МТ

	+----------------+-------------------+-----------------------------------------+-------------+
	| DocflowNamedId | Status.NamedId    | Status.FriendlyName                     | Status.Type |
	+================+===================+====================================++===+=============+
	| TtGis          | SendingInProgress | Передается в ГИС МТ «Честный ЗНАК»      | Normal      |
	+----------------+-------------------+-----------------------------------------+-------------+
	| TtGis          | GisReceivingError | Ошибка передачи в ГИС МТ «Честный ЗНАК» | Error       |
	+----------------+-------------------+-----------------------------------------+-------------+
	| TtGis          | InProcessing      | Обрабатывается в ГИС МТ «Честный ЗНАК»  | Normal      |
	+----------------+-------------------+-----------------------------------------+-------------+
	| TtGis          | SuccessProcessed  | Обработан в ГИС МТ «Честный ЗНАК»       | Success     |
	+----------------+-------------------+-----------------------------------------+-------------+
	| TtGis          | ProcessingError   | Ошибка в ГИС МТ «Честный ЗНАК»          | Error       |
	+----------------+-------------------+-----------------------------------------+-------------+

Передается в ГИС МТ «Честный ЗНАК»
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Статус возвращается, если ГИС МТ «Честный ЗНАК» недоступен: документ передать не удалось, но попытки передачи продолжаются. От участников документооборота не требуются дополнительные действия.

В ответе возвращается:

- статус,
- файл с текстом ошибки.


Ошибка передачи в ГИС МТ «Честный ЗНАК»
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Статус возвращается, если при передаче документа в ГИС МТ «Честный ЗНАК» получена ошибка 4хх или 500: документ передать не удалось, повторные попытки передачи не выполняются. От участников документооборота не требуются дополнительные действия. После устранения проблем передачи сервис автоматически переотправит документы.

В ответе возвращается:

- статус,
- транспортная квитанция ГИС МТ.

Обрабатывается в ГИС МТ «Честный ЗНАК»
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Статус возвращается после успешной передачи документа в ГИС МТ «Честный ЗНАК». От участников документооборота не требуются дополнительные действия.

В ответе возвращается:

- статус,
- транспортная квитанция ГИС МТ.

Обработан в ГИС МТ «Честный ЗНАК»
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Статус возвращается после успешной обработки документа в ГИС МТ «Честный ЗНАК» и означает, что произошел переход прав собственности на маркированные товары. Товары из документа можно реализовывать дальше.

В ответе возвращается:

- статус,
- технологическая квитанция ГИС МТ.

Ошибка в ГИС МТ «Честный ЗНАК»
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Статус возвращается, если в процессе обработки документа в ГИС МТ «Честный ЗНАК» возникли ошибки.  Проанализируйте ошибки и исправьте их. Аннулируйте текущий документ и выставьте новый или отправьте исправление или корректировку.

В ответе возвращается:

- статус,
- технологическая квитанция ГИС МТ,
- список ошибок, которые возникли в ходе обработки документа.