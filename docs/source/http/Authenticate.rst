Authenticate
============

Метод предназначен для аутентификации.

Версии метода:

    :ref:`Authenticate_v3`
    Authenticate v2 — устаревшая версия
    Authenticate — устаревшая версия

.. _Authenticate_v3:

Authenticate v3
---------------

.. http:post:: /V3/Authenticate

	:queryparam type: способ аутентификации. Параметр не может быть пустым. Может принимать значения:
                        - ``password`` — логин и пароль,
                        - ``certificate`` — сертификат,
                        - ``sid`` — auth.sid из API Аутентификатора,
                        - ``trust`` — доверительная аутентификация.

	:requestheader Authorization: данные, необходимые для авторизации. В заголовке нужно передать ``ddauth_api_client_id``.

    :request Body: зависит от способа аутентификации.

	:statuscode 200: операция успешно завершена.
	:statuscode 400: данные в запросе имеют неверный формат или отсутствуют обязательные параметры.
	:statuscode 401: в запросе отсутствует HTTP-заголовок ``Authorization``, или в этом заголовке отсутствует параметр ``ddauth_api_client_id``, или переданный в нем ключ разработчика не зарегистрирован в Диадоке.
	:statuscode 405: используется неподходящий HTTP-метод.
	:statuscode 500: при обработке запроса возникла непредвиденная ошибка.

    :response Body: зависит от способа аутентификации.

- **Аутентификация по логину и паролю** :
    
 ``type=password``
В теле запроса нужно передавать сериализованный объект.

Данные можно передавать в формате json, в этом случае укажите заголовок ``Content-Type: application/json``

.. code-block:: json 
    
   
    { 
        "login" : "login",
        "password" : "pass" 
    }

Если вы передаете данные в формате protobuf, ``Content-Type`` указывать необязательно, так как по умолчанию десериализация происходит из protobuf.

.. code-block:: protobuf

    message LoginPassword {
        required string Login = 1;
        required string Password = 2;
    }

В ответ на запрос метод вернет авторизационный токен.

- **Аутентификация по сертификату**:

``type=certificate``

В тело запроса передайте бинарное содержимое открытого ключа сертификата c заголовком ``Content-Type: application/octet-stream``.

В ответ метод вернет зашифрованную строку. Чтобы получить авторизационный токен:

1. Расшифруйте ответ закрытым ключом сертификата пользователя.
2. Полученный массив байтов закодируйте в :rfc:`Base64 <3548>` - строку.
3. Передайте результат на вход :doc:`AuthenticateConfirm`, в ответ метод вернет авторизационный токен.

- **Аутентификация по auth.sid API аутентификатора** :

``type=sid``

В теле запроса нужно передавать ``auth.sid`` c заголовком ``Content-Type: text/plain``

Чтобы получить auth.sid, аутентифицируйтесь с помощью сервиса Auth.API по `сертификату <https://developer.kontur.ru/doc/auth/method?type=post&path=%2Fauth%2Fv5.17%2Fauthenticate-by-cert>`__ или `паролю <https://developer.kontur.ru/doc/auth/method?type=post&path=%2Fauth%2Fv5.17%2Fauthenticate-by-pass>`__.

- **Доверительная аутентификация**

``type=trust``

С помощью доверительной аутентификации можно перейти из стороннего доверенного сервиса в Диадок без дополнительной аутентификации. 

Функциональность платная. Для подключения обратитесь к менеджеру или в `техническую поддержку <https://www.diadoc.ru/support>`__.

Для доверительной аутентификации нужно привязать пользователя доверенного сервиса к пользователю Диадока. 

При аутентификации по логину привязка происходит автоматически, в запросе нужно указать заголовки:

    + X-Diadoc-ServiceKey (ServiceKey)
    + X-Diadoc-ServiceUserId (ServiceUserId)

При аутентификации по сертификату привязку пользователя нужно сделать с помощью метода :doc:`AuthenticateConfirm` с указанием параметра ``saveBinding=true``.
