Служебные документы
===================

.. contents:: :local:
	:depth: 3

Получение служебных документов
------------------------------

.. _service_get_InvoiceConfirmation:

Получение подтверждения оператора
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

После отправки титула продавца Диадок автоматически формирует подтверждение оператора о дате получения документа. Получить подтверждение оператора можно с помощью метода :doc:`../http/GetMessage`. В запросе нужно передать идентификаторы ящика, сообщения и отправленного титула продавца.

В ответе метод вернет структуру :doc:`../proto/Message` с вложенной структурой :doc:`../proto/Entity`. Подтверждение оператора будет представлено структурой ``Entity`` со следующими полями:

	- ``EntityType = Attachment``,
	- ``AttachmentType = InvoiceConfirmation``.

**Пример HTTP-запроса метода GetMessage:**

.. code-block:: http

	GET /V5/GetMessage?boxId=db32772b-9256-49a8-a133-fda593fda38a&messageId=bbcedb0d-ce34-4e0d-b321-3f600c920935entityId=30cf2c07-7297-4d48-bc6f-ca7a80e2cf95 HTTP/1.1
	Host: diadoc-api.kontur.ru
	Accept: application/json
	Content-Type: application/json charset=utf-8
	Authorization: DiadocAuth ddauth_api_client_id={{ключ разработчика}}, ddauth_token={{авторизационный токен}}


.. _service_get_InvoiceReceipt:

Получение извещения о получении
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

После получения титула продавца покупатель формирует извещение о получении титула и отправляет его продавцу. Получить извещение о получении можно с помощью метода :doc:`../http/GetMessage`. В запросе нужно передать идентификаторы ящика, сообщения и отправленного титула покупателя.

В ответе метод вернет структуру :doc:`../proto/Message` с вложенной структурой :doc:`../proto/Entity`. Подтверждение оператора будет представлено структурой ``Entity`` со следующими полями:

	- ``EntityType = Attachment``,
	- ``AttachmentType = InvoiceReceipt``.


Генерация и отправка служебных документов
-----------------------------------------

Диадок позволяет сгенерировать следующие служебные ответные документы:

	- извещение о получении (ИоП),
	- предложение об аннулировании,
	- отказ от подписи,
	- отказ от предложения об аннулировании,
	- уведомление об уточнении счета-фактуры (УоУ).

Эти документы можно отправить с помощью метода :doc:`../http/PostMessagePatch`, передав ему на вход структуру :doc:`../proto/MessagePatchToPost` с соответствующим заполненным полем.


.. _service_send_InvoiceReceipt:

Извещение о получении
~~~~~~~~~~~~~~~~~~~~~

Возможность отправки ИоП для каждого типа документа задается в свойствах :doc:`вида документооборота <../docflows/Workflows>`.

Сформировать ИоП можно с помощью метода :doc:`../http/GenerateReceiptXml`. В запросе нужно передать идентификаторы ящика, сообщения и полученного титула продавца.

**Пример HTTP-запроса метода GenerateReceiptXml:**

.. code-block:: http

	GET V2/GenerateReceiptXml?boxid=db32772b-9256-49a8-a133-fda593fda38a HTTP/1.1
	Host: diadoc-api.kontur.ru
	Accept: application/json
	Content-Type: application/json charset=utf-8
	Authorization: DiadocAuth ddauth_api_client_id={{ключ разработчика}}, ddauth_token={{авторизационный токен}}

**Пример тела запроса:**

.. code-block:: json

	{
		"MessageId": "bbcedb0d-ce34-4e0d-b321-3f600c920935",
		"AttachmentId": "30cf2c07-7297-4d48-bc6f-ca7a80e2cf95",
		"SignerContent": "PD94bWwgdmVyc2l...LDQudC7Pg==",        // бинарное представление XML-файла универсального подписанта
	}

В ответе метод вернет XML-файл ИоПа для сущности ``attachmentId`` из сообщения ``messageId`` в ящике ``boxId``.

Сформированное извещение о получении документа можно отправить с помощью метода :doc:`../http/PostMessagePatch`.

В теле запроса метода передайте структуру :doc:`../proto/MessagePatchToPost`, заполненную следующими данными:

	- ``BoxId`` — идентификатор ящика, в котором находится исходное сообщение;
	- ``MessageId`` — идентификатор сообщения, к которому относится дополнение;
	- ``Receipts`` — вложенная структура для передачи XML-файла ИоП:

		- ``ParentEntityId`` — идентификатор титула продавца;
		- ``SignedContent.Content`` — XML-файл ИоП;
		- ``SignedContent.Signature`` — файл подписи,
		- ``Labels`` — :doc:`метки <../entities/label>` (необязательно).

**Пример тела запроса:**

.. code-block:: json

	"BoxId": "db32772b-9256-49a8-a133-fda593fda38a",
	"MessageId": "bbcedb0d-ce34-4e0d-b321-3f600c920935",
	"Receipts":
	[
		{
			"ParentEntityId":"30cf2c07-7297-4d48-bc6f-ca7a80e2cf95&",
			"SignedContent":
			{
				"Content": "PD94bWwgdmVyc2l...LDQudC7Pg==",        //контент xml-файла в кодировке base-64
				"Signature": "MIIN5QYJKoZIhvc...KsTM6zixgz"        //контент файла подписи в кодировке base-64
			},
			"Label": "text"
		}
	]


Предложение об аннулировании
~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Если вы обнаружили ошибки в отправленном документе, его можно аннулировать. Для этого сгенерируйте и отправьте предложение об аннулировании. 

Сгенерировать предложение об аннулировании можно с помощью метода :doc:`../http/GenerateRevocationRequestXml`. Можно отправить предложение об аннулировании форматов 1.01 и 1.02. В ответе метод вернет сформированный XML-файл предложения об аннулировании.

Полученный XML-файл нужно передать в поле ``RevocationRequests`` структуры ``MessagePatchToPost``.


Отказ от подписи и отказ от предложения об аннулировании
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Сгенерировать отказ можно с помощью метода :doc:`../http/GenerateSignatureRejectionXml`. В ответе метод вернет сформированный XML-файл отказа.

Полученный XML-файл нужно передать в поле ``XmlSignatureRejections`` структуры ``MessagePatchToPost``.


Уведомление об уточнении счета-фактуры
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Чтобы создать запрос на исправление или корректировку счета-фактуры, сгенерируйте и отправьте уведомление об уточнении.

Сгенерировать уведомление об уточнении можно с помощью метода :doc:`../http/GenerateInvoiceCorrectionRequestXml`. В ответе метод вернет сформированный XML-файл уведомления.

Полученный XML-файл нужно передать в поле ``CorrectionRequests`` структуры ``MessagePatchToPost``.

.. _universal_signer:

Универсальный подписант
~~~~~~~~~~~~~~~~~~~~~~~

При генерации извещения о получении, отказа от подписи и уведомления об уточнении нужно передавать бинарное представление xml-файла универсального подписанта в поле ``SignerContent``. Файл необходимо сформировать в соответствии с :download:`XSD-схемой <../xsd/TechnologicalSigner133UserContract1505.xsd>`.

Пример xml-файла универсального подписанта:

::

    <?xml version="1.0" encoding="UTF-8"?>
    <Signer SignerStatus="2" SignatureType="1">
        <Certificate CertificateBytes="PD94bWwgdmVy...c2l"/>
        <Fio LastName="Петров" FirstName="Петр" MiddleName="Петрович"/>
        <Position PositionSource="Manual">Подписант-Должн</Position>
        <PowerOfAttorney>
        <Electronic MethodOfProviding="1">
            <Manual RegistrationNumber="4a743152-e772-4249-9a47-e2e290258e79" RegistrationDate="17.09.2018" InternalNumber="123" InternalDate="18.09.2018" SystemId="СвДоверЭл-ИдСистХран"/>
        </Electronic>
        </PowerOfAttorney>
    </Signer>

- ``SignerStatus`` — статус подписанта, может принимать значения:

	- 1 — лицо, имеющее полномочия на подписание документа без доверенности,
	- 2 — лицо, имеющее полномочия на подписание документа на основании доверенности в электронной форме,
	- 3 — лицо, имеющее полномочия на подписание документа на основании доверенности на бумажном носителе.

- ``SignatureType`` — тип подписи, может принимать значения:

	- 1 — усиленная квалифицированная электронная подпись,
	- 2 — простая электронная подпись,
	- 3 — усиленная неквалифицированная электронная подпись.

- ``Certificate`` — данные сертификата подписанта. Обязательное поле. Можно передать:

	- ``CertificateThumbprint`` — отпечаток сертификата,
	- ``CertificateBytes`` — сертификат, сериализованный в массив байтов в DER-кодировке.

- ``Fio`` — фамилия, имя, отчество подписанта.

	- ``LastName`` — фамилия подписанта, обязательное поле,
	- ``FirstName`` — имя подписанта, обязательное поле,
	- ``MiddleName`` — отчество подписанта.

- ``Position`` — должность подписанта.
- ``PositionSource`` — способ заполнения должности сотрудника. Обязательное поле. Может принимать значения:

	- ``Employee`` — заполнение из данных сотрудника в Диадоке,
	- ``Certificate`` — заполнение из данных в сертификате,
	- ``Manual`` — ручное заполнение данных.

- ``PowerOfAttorney`` — сведения о машиночитаемой доверенности. Доверенность может быть электронной или бумажной.

	- ``Electronic`` — электронная доверенность. Данные доверенности можно заполнить автоматически или вручную.

		- ``MethodOfProviding`` — способ представления доверенности. Обязательное поле. Может принимать значения:

			- 1 — представление доверенности осуществляется посредством ее включения в пакет электронных документов,
			- 2 — представление доверенности способом, не предусматривающим его включение в пакет электронных документов.

		- ``Storage`` — автоматическое заполнение информации по доверенности на основе номера и ИНН:

			- ``RegistrationNumber`` — номер доверенности, обязательное поле,
			- ``IssuerInn`` — ИНН организации, выдавшей доверенность, обязательное поле,
			- ``UseDefault`` — флаг, указывающий, нужно ли автоматически заполнить информацию на основе доверенности, используемой сотрудником по умолчанию. Обязательное поле.

		- ``Manual`` — ручное заполнение данных доверенности. Можно указать следующие данные:

			- ``RegistrationNumber`` — номер доверенности, обязательное поле,
			- ``RegistrationDate`` — дата совершения (выдачи) доверенности, обязательное поле,
			- ``InternalNumber`` — внутренний регистрационный номер доверенности,
			- ``InternalDate`` — дата внутренней регистрации доверенности,
			- ``SystemId`` — идентифицирующая информация об информационной системе, в которой осуществляется хранение доверенности.

	- ``Paper`` — бумажная доверенность. Можно указать следующие данные:

		- ``Fio`` — фамилия, имя, отчество (при наличии) лица, подписавшего доверенность,
		- ``InternalNumber`` — внутренний регистрационный номер доверенности, обязательное поле,
		- ``RegistrationDate`` — дата совершения (выдачи) доверенности, обязательное поле,
		- ``IssuerInfo`` — сведения о доверителе.

Пример ответа метода :doc:`../http/GenerateReceiptXml`:

::

  <?xml version="1.0" encoding="windows-1251"?>
  <Файл ИдФайл="DP_IZVPOL_2BM-9616675014-961601000-201906250926373816603_2BM-7770357771-2012082810454029703720000000000_20230904_54c96f37-a745-4e02-8dda-41404992952f" ВерсПрог="Diadoc 1.0" ВерсФорм="1.03">
    <Документ КНД="1115110">
      <УчастЭДО ИдУчастЭДО="2BM-7770357771-2012082810454029703720000000000">
        <ЮЛ НаимОрг="ОАО" ИННЮЛ="7770357771" КПП="770101001" />
      </УчастЭДО>
      <СвИзвПолуч ДатаПол="04.09.2023" ВремяПол="13.32.26">
        <СведПолФайл ИмяПолФайла="ON_NSCHFDOPPR_2BM-7770357771-2012082810454029703720000000000_2BM-9616675014-961601000-201906250926373816603_20200826_6efc7ad3-88ff-485d-86bb-c84c2262caf2">
          <ЭППолФайл>MIINB3RI=...</ЭППолФайл>
        </СведПолФайл>
      </СвИзвПолуч>
      <ОтпрДок ИдУчастЭДО="2BM-9616675014-961601000-201906250926373816603">
        <ЮЛ НаимОрг="ООО" ИННЮЛ="9616675014" КПП="961601000" />
      </ОтпрДок>
      <Подписант ТипПодпис="1" СтатПодп="2" Должн="Подписант-Должн">
        <ФИО Фамилия="Петров" Имя="Петр" Отчество="Петрович" />
        <СвДоверЭл СпособПредставл="1" НомДовер="4a743152-e772-4249-9a47-e2e290258e79" ДатаВыдДовер="17.09.2018" ВнНомДовер="123" ДатаВнРегДовер="18.09.2018" ИдСистХран="СвДоверЭл-ИдСистХран" />
      </Подписант>
    </Документ>
  </Файл>