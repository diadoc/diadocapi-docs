Работа с машиночитаемой доверенностью
=====================================

.. contents:: :local:
	:depth: 3

С 1 марта 2022 года вступают в силу поправки в `Федеральный закон от 06.04.2011 № 63-ФЗ <https://normativ.kontur.ru/document?moduleId=1&documentId=416095>`__. Изменения заключаются в том, что для подписания документов сотрудники компаний могут использовать сертификаты физического лица, в которых указаны только их личные данные без указания принадлежности к организации. Однако только подписи физического лица при обмене документами недостаточно, чтобы вести юридически значимый документооборот организации. Для подтверждения полномочий сотрудника и его принадлежности к компании руководитель должен выпустить машиночитаемую доверенность.

**Машиночитаемая доверенность (МЧД)** — электронный документ в формате XML, с помощью которого руководитель организации передает сотруднику полномочия для подписания документов. С помощью МЧД сотрудники могут ставить подписи от лица организации.
Документ содержит данные о:

- доверителе — организации, которая выдала доверенность,
- доверенном лице — физическом лице, которое уполномочено совершать действие,
- полномочиях сотрудника.

МЧД нужно передавать вместе с каждым документом, который был подписан сертификатом физического лица. Она будет использоваться при подписании документа и таких действиях с документом, как:

- отказ в подписи,
- запрос аннулирования,
- отказ в аннулировании,
- аннулирование,
- запрос уточнения,
- подписание извещения о получении документа.

Чтобы перейти на новый формат подписания документов, сотрудники  и уполномоченные лица организаций должны использовать сертификат физического лица и прикладывать к нему МЧД.

.. note::

	На время переходного периода, пока это не является обязательным требованием, использовать МЧД с сертификатом физического лица не обязательно.
 
Процесс работы с МЧД в Диадоке представлен следующими этапами:

.. contents:: :local:
	:depth: 1


Управление доверенностями
-------------------------

API Диадока предоставляет функциональность для удобной работы с МЧД: вы можете зарегистрировать МЧД и привязать ее к сотруднику, чтобы управлять списком МЧД и выбирать их при подписании документа. 

Использовать МЧД через API Диадока можно без регистрации. Но если вы хотите использовать МЧД в веб-интерфейсе Диадока, ее обязательно нужно зарегистрировать.

Зарегистрировать МЧД может администратор ящика организации или сам сотрудник. Для этого нужно:

- выпустить доверенность в сервисе Контур.Доверенность по `инструкции <https://support.kontur.ru/pages/viewpage.action?pageId=83873849>`__: Диадок не выпускает МЧД;
- получить информацию о МЧД для ее добавления в Диадок: *XML-файл МЧД + ЭП руководителя* или *регистрационный номер МЧД + ИНН доверителя*;
- :ref:`зарегистрировать МЧД в Диадоке <powerofattorney_register>`;

После этого можно:

- :ref:`привязать МЧД к сотруднику <powerofattorney_employee>`, чтобы работать со списком МЧД сотрудника,
- :ref:`установить МЧД по умолчанию <powerofattorney_employee>`, чтобы не выбирать МЧД при каждом действии с документами.

Кроме этого Диадок позволяет :ref:`управлять <powerofattorney_employee>` уже привязанными к сотруднику доверенностями:

- получить список МЧД, привязанных к сотруднику,
- отвязать МЧД от сотрудника,
- изменить для МЧД настройку «по умолчанию».


.. _powerofattorney_register:

Регистрация МЧД
~~~~~~~~~~~~~~~

Чтобы зарегистрировать МЧД, вызовите метод :doc:`../http/RegisterPowerOfAttorney`. Метод вернет идентификатор задачи ``taskId``.

Передайте идентификатор ``taskId`` в метод :doc:`../http/RegisterPowerOfAttorneyResult`, чтобы узнать результат регистрации.

После регистрации МЧД можно привязать ее к сотруднику.


.. _powerofattorney_employee:

Работа с МЧД сотрудника
~~~~~~~~~~~~~~~~~~~~~~~

К каждому сотруднику можно привязать до 100 действующих или не вступивших в силу МЧД. Любую из них можно использовать как доверенность по умолчанию. Пользователь в любой момент может сделать доверенностью по умолчанию другую МЧД или убрать доверенность по умолчанию совсем. Любую МЧД, уже привязанную к сотруднику, можно отвязать.

Работать с МЧД сотрудника можно с помощью методов:

- :doc:`../http/AddEmployeePowerOfAttorney` — привязывает МЧД к сотруднику;
- :doc:`../http/DeleteEmployeePowerOfAttorney` — отвязывает МЧД от сотрудника;
- :doc:`../http/UpdateEmployeePowerOfAttorney` — устанавливает сотруднику доверенность по умолчанию или снимает с доверенности такой признак;
- :doc:`../http/GetEmployeePowersOfAttorney` — возвращает список всех МЧД, привязанных к сотруднику.


Предварительная проверка МЧД
----------------------------

Перед отправкой документа можно проверить МЧД:

- соответствует ли МЧД установленному формату,
- является ли МЧД действующей (без учета отзыва),
- верна ли подпись, которой подписана МЧД,
- соответствует ли МЧД сертификату, которым будет подписан документ,
- отозвана ли МЧД — проверяется в тех случаях, когда за отведенное время удастся получить информацию о статусе МЧД от сервиса ФНС.

Для предварительной проверки МЧД используйте метод :doc:`../http/PrevalidatePowerOfAttorney`.


Проверка полномочий МЧД
-----------------------

При отправке или после получения документа с МЧД вы можете проверить, соответствуют ли полномочия в МЧД этому документу. Так вы сможете убедиться в корректности подписания документа сертификатом физического лица с указанной МЧД.

Посмотреть полномочия в МЧД можно в поле :doc:`PermissionsInfo <../proto/PowerOfAttorneyPermissionsInfo>` структуры :doc:`../proto/PowerOfAttorney`, полученной следующими способами:

	- при :ref:`регистрации МЧД <powerofattorney_register>` — в структуре :doc:`../proto/PowerOfAttorneyRegisterResult`;
	- при :ref:`получении и изменении МЧД сотрудника <powerofattorney_employee>` —  в структуре :doc:`../proto/EmployeePowerOfAttorney`;
	- при получении информации о МЧД методом :doc:`../http/GetPowerOfAttorneyInfo`.


Формирование документа с МЧД
----------------------------

При формировании формализованного документа нужно учесть данные об организации в блоке ``Подписант``. Для этого вместе с сертификатом физического лица укажите данные МЧД:

- при :ref:`генерации титула с МЧД <generate_title_xml_poa>` методом :doc:`../http/GenerateTitleXml`. Метод заполняет поля блока ``Подписант`` данными, полученными из МЧД.
- при подготовке документа к подписанию методом :doc:`../http/PrepareDocumentsToSign`: для этого в поле ``SignerContent`` структуры :doc:`../proto/PrepareDocumentsToSignRequest` передайте XML-файл универсального подписанта с данными МЧД.


.. _powerofattorney_send:

Отправка документа с МЧД и ответное действие
--------------------------------------------

Алгоритм заполнения МЧД при отправке первичного документа и при выполнении ответного действия с документом идентичны.

Отправить документ с МЧД или выполнить ответное действие можно с помощью методов:

	- :doc:`../http/PostMessage`,
	- :doc:`../http/PostMessagePatch`,
	- :doc:`../http/SendDraft`.

Эти методы принимают на вход соответственно структуры :doc:`../proto/SignedContent`, :doc:`../proto/DocumentSignature` и :doc:`../proto/DocumentSenderSignature`, которые хранят информацию о МЧД внутри структуры :doc:`../proto/PowerOfAttorneyToPost`.

Передать МЧД можно одним из следующих способов:

	- **Файлом в составе пакета документов**. Этот способ может быть применен, например, при отправке документа в роуминг.
	- **С помощью реквизитов**. Этот способ позволяет передать МЧД в составе пакета документов и при этом не прикладывать ее физически. Вы указываете реквизиты МЧД или выбираете МЧД по умолчанию, а Диадок сам скачает файл МЧД из реестра ФНС или из хранилища и приложит его при отправке документа.
	- **В содержимом документа**. Этот способ позволяет указать МЧД при генерации документа в его теле. Он применим только для обновленных форматов документов (см. в таблице ниже).

Для каждого способа передачи МЧД существуют свои правила заполнения структуры ``PowerOfAttorneyToPost`` и условия их применения.

.. table:: Способы передачи МЧД

	+------------------------------------+-------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------+
	| Способ передачи                    | Как указать МЧД                                                         | Условия                                                                                                                  |
	+====================================+=========================================================================+==========================================================================================================================+
	| Файлом в составе пакета документов | Передать в поле ``Contents`` файл МЧД и подпись                         | Наличие файла МЧД и подписи                                                                                              |
	|                                    +-------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------+
	|                                    | Выбрать ``UseDefault`` или заполнить ``FullId`` с флагом ``SendAsFile`` | Наличие у сотрудника доверенности по умолчанию или указанной доверенности                                                |
	+------------------------------------+-------------------------------------------------------------------------+                                                                                                                          |
	| С помощью реквизитов               | Выбрать ``UseDefault`` или заполнить ``FullId``                         |                                                                                                                          |
	+------------------------------------+-------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------+
	| В содержимом документа             | Выбрать ``UseDocumentContent``                                          | Заполненный блок c МЧД в XML-файле титула, сформированного методом :doc:`../http/GenerateTitleXml`.                      |
	|                                    |                                                                         | Применимо только для акта сверки 405 формата, акта о приемке выполненных работ КС-2 691 формата и документов 970 формата |
	+------------------------------------+-------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------+

Приложить МЧД к документу можно только одним из вышеперечисленных способом. Если вы указали МЧД сразу несколькими способами, то с документом будет отправлена та, которая выбрана с помощью параметров структуры ``PowerOfAttorneyToPost``: они взаимоисключают друг друга.

Если МЧД была выпущена в порядке передоверия, то в поле ``PowerOfAttorneyToPost.Contents`` вы можете либо указать конечную МЧД, либо передать всю цепочку файлов МЧД. Переданную цепочку файлов МЧД можно получить из отправленного сообщения методом :doc:`../http/GetPowerOfAttorneyInfo`.


Получение документа с МЧД
-------------------------


Проверка приложенности МЧД к подписи
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Чтобы при обработке входящих документов определить, к каким документам должна быть приложена МЧД, а к каким — нет, вы можете получить информацию о статусе приложенности МЧД к подписи. Например, при подписании документа сертификатом юридического лица машиночитаемая доверенность не требуется. А если документ был подписан сертификатом физического лица, то к подписи такого документа обязательно должна быть приложена МЧД.

Информация о статусе приложенности МЧД к подписи хранится в структуре :doc:`../proto/PowerOfAttorneyAttachmentStatus` и возвращается в поле ``PowerOfAttorneyAttachmentStatus`` в структурах :doc:`../proto/Entity message` и :doc:`../proto/SignatureV3`.

Кроме этого вы можете узнать тип владельца сертификата — он возвращается в поле ``CertificateSubjectType`` структуры :doc:`../proto/SignatureInfo`, полученной методом :doc:`../http/GetSignatureInfo`.


Получение содержимого МЧД
~~~~~~~~~~~~~~~~~~~~~~~~~

Если при отправке документа МЧД была приложена к нему файлом или указана с помощью реквизитов, то вы можете получить файл такой МЧД из отправленного сообщения. Для этого используйте метод :doc:`../http/GetPowerOfAttorneyContent`.


Получение цепочки передоверия МЧД
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Если МЧД, приложенная к документу, была выпущена в порядке передоверия, то вы можете ее получить из отправленного сообщения методом :doc:`../http/GetPowerOfAttorneyInfo`.

Цепочка передоверия вернется в поле ``DelegationInfo`` структуры :doc:`../proto/PowerOfAttorney`.


Получение МЧД в сообщении
~~~~~~~~~~~~~~~~~~~~~~~~~

Чтобы получить информацию о МЧД в сообщении, используйте методы:

- :doc:`../http/GetMessage`,
- :doc:`../http/GetNewEvents`,
- :doc:`../http/GetLastEvent`,
- :doc:`../http/GetEvent`.

Они возвращают информацию о МЧД и ее статусе внутри структуры :doc:`../proto/Message` в поле :doc:`Entities.PowerOfAttorneyInfo <../proto/Entity message>`, представленном структурой :doc:`../proto/PowerOfAttorneyInfo`.


Получение МЧД в документах
~~~~~~~~~~~~~~~~~~~~~~~~~~

Чтобы получить информацию о МЧД в документах, используйте методы:

- :doc:`../http/GetDocument`,
- :doc:`../http/GetDocuments`,
- :doc:`../http/GetDocumentsByMessageId`.

Они возвращают информацию об общем (сводном) статусе по всем МЧД для всех сущностей документа внутри структуры :doc:`../proto/Document` в поле :doc:`DocflowStatus.PowerOfAttorneyValidationStatus <../proto/DocflowStatusV3>`, представленном структурой :doc:`../proto/PowerOfAttorneyValidationStatus`.

Чтобы получить подробную информацию о МЧД, отправленной с документом, используйте метод :doc:`../http/GetPowerOfAttorneyInfo`. Он вернет данные в виде структуры :doc:`../proto/PowerOfAttorney`.


Получение МЧД в docflow
~~~~~~~~~~~~~~~~~~~~~~~

Чтобы получить информацию о МЧД в docflow, используйте методы:

- :doc:`../http/GetDocflowEvents_V3`,
- :doc:`../http/GetDocflows_V3`,
- :doc:`../http/GetDocflowsByPacketId_V3`,
- :doc:`../http/SearchDocflows_V3`.

Они возвращают:

- информацию об общем (сводном) статусе по всем МЧД для всех сущностей документа внутри структуры :doc:`../proto/DocflowStatusV3` в поле ``PowerOfAttorneyValidationStatus``, представленном структурой :doc:`../proto/PowerOfAttorneyValidationStatus`;
- информацию о МЧД и ее статусе из подписи под документом внутри структуры :doc:`../proto/SignatureV3` в поле ``PowerOfAttorney``, представленном структурой :doc:`../proto/SignaturePowerOfAttorney`;
- статус приложенности машиночитаемой доверенности к подписи внутри структуры :doc:`../proto/SignatureV3` в поле ``PowerOfAttorneyAttachmentStatus``, представленном структурой :doc:`../proto/PowerOfAttorneyAttachmentStatus`.

Кроме этого, используя значение поля ``DocumentWithDocflowV3.DocumentId`` вы можете с помощью методов получения МЧД в документах получить подробную информацию о МЧД в виде структуры :doc:`../proto/PowerOfAttorney`.


----

.. rubric:: См. также

*Методы для работы с МЧД:*
	- :doc:`../http/AddEmployeePowerOfAttorney` — привязывает МЧД к сотруднику
	- :doc:`../http/DeleteEmployeePowerOfAttorney` — отвязывает МЧД от сотрудника
	- :doc:`../http/GetEmployeePowersOfAttorney` — возвращает МЧД, привязанные к сотруднику
	- :doc:`../http/GetPowerOfAttorneyContent` — возвращает содержимое файлов МЧД и родительских МЧД
	- :doc:`../http/GetPowerOfAttorneyInfo` — возвращает информацию о МЧД, отправленной с документом
	- :doc:`../http/PrevalidatePowerOfAttorney` — выполняет предварительную проверку МЧД
	- :doc:`../http/RegisterPowerOfAttorney` — отправляет запрос на регистрацию МЧД
	- :doc:`../http/RegisterPowerOfAttorneyResult` — возвращает результат регистрации МЧД
	- :doc:`../http/UpdateEmployeePowerOfAttorney` — изменяет параметр МЧД «Использовать по умолчанию»
	
*Структуры для работы с МЧД:*
	- :doc:`../proto/EmployeePowerOfAttorney` — хранит информацию о МЧД, привязанной к сотруднику
	- :doc:`../proto/PowerOfAttorney` — хранит информацию о МЧД
	- :doc:`../proto/PowerOfAttorneyAttachmentStatus` — представляет собой статус приложенности МЧД к подписи
	- :doc:`../proto/PowerOfAttorneyFullId` — хранит идентификатор МЧД
	- :doc:`../proto/PowerOfAttorneyInfo` — хранит информацию о МЧД и статусе ее проверки
	- :doc:`../proto/PowerOfAttorneyPermissionsInfo` — хранит информацию о полномочиях из машиночитаемой доверенности
	- :doc:`../proto/PowerOfAttorneyPrevalidateRequest` — хранит данные для предварительной проверки МЧД
	- :doc:`../proto/PowerOfAttorneyRegisterResult` — хранит данные о результате регистрации МЧД
	- :doc:`../proto/PowerOfAttorneySendingType` — представляет собой способ передачи МЧД
	- :doc:`../proto/PowerOfAttorneySignedContent` — представляет собой содержимое файла МЧД с подписью
	- :doc:`../proto/PowerOfAttorneyToPost` — предназначена для заполнения данных о МЧД при отправке документов
	- :doc:`../proto/PowerOfAttorneyToRegister` — хранит данные для регистрации МЧД
	- :doc:`../proto/PowerOfAttorneyToUpdate` — используется для обновления настроек МЧД для сотрудника
	- :doc:`../proto/PowerOfAttorneyValidationStatus` — хранит информацию о статусе проверки МЧД
	- :doc:`../proto/SignaturePowerOfAttorney` — хранит информацию о МЧД, использованной при подписании документа, и статусе ее проверки